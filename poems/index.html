<html>
<head>
  <title>Murali's Poems</title>

  <meta charset="utf-8"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>

  <meta name="description" content="Murali's Poems are a collection of poems and songs."></meta>
  <meta name="author" content="Murali Krishnan"></meta>

  <link rel="icon" href="images/logo1.jpg" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" integrity="sha512-BnbUDfEUfV0Slx6TunuB042k9tuKe3xrD6q4mg5Ed72LTgzDIcLPxg6yI2gcMFRyomt+yJJxE+zJwNmxki6/RA==" crossorigin="anonymous" />

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    rel="stylesheet"   crossorigin="anonymous"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z">
    </link>
  <link href="css/styles.css" rel="stylesheet"></link>

</head>
<!-- Get the poem text from external file using async methods -->

<body id="root2">
  <nav class="navbar navbar-expand-lg navbar-light fixed-top st-navbar"
    style="background-color: wheat;">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">
          <img id="logo" alt="Murali's Poems" src="images/logo1.jpg"/>
          Murali's Poems
        </a>
      </div>

      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div
        id="navbarSupportedContent"
        class="navbar-collapse collapse">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link active" href="#">Home</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="#poems">Poems</a>
          </li>

          <li class="nav-item" share-button>
            <a class="nav-link"
              href="javascript:useShareHelper( 'Poems from Murali', 'Enjoy the poems', 'https://zanavu.com/poems')">
              Share</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="https://zanavu.com/notes">Blog</a>
          </li>

          <li class="nav-item dropdown ml-md-auto">
            <a id="navbarDropdownMenuLink"
              class="nav-link dropdown-toggle"
              href="#" data-toggle="dropdown">About</a>

            <div
              class="dropdown-menu dropdown-menu-right "
              aria-labelledby="navbarDropdownMenuLink">

              <a class="dropdown-item" href="https://zanavu.com">About Us</a>

              <div class="dropdown-divider"></div>

              <a class="dropdown-item" href="#contactus">Contact Us</a>

            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

<div class="container">
  <div id="poems" class="jumbotron">
    <div class="row">
      <div class="col-6 col-sm-4 d-flex justify-content-center">
        <ul class="nav nav-pills" id="sidebar_links">
          <!-- the sidebar items will be dynamically added -->

        </ul>
      </div>

      <hr/>
      <div class="tab-content col-sm-8" id="main_content">
        <!-- the main content items will be dynamically added -->

      </div>
    </div>
  </div>

  <div id="output">
    <!-- notes on sharing ... -->
  </div>

  <footer>
    <div className="container">
      <div className="row justify-content-center">
          <div className="col-auto">
            <p>
              Copyright &copy; 2020  Murali Krishnan
              <br/>
            </p>
          </div>
      </div>
    </div>
  </footer>
</div>

<script
  src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
  integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
  crossorigin="anonymous">
</script>

<script
  src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
  integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
  crossorigin="anonymous">
</script>

<script
  src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
  integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
  crossorigin="anonymous">
</script>

<script type="module" src="js/ShareHelper.js"></script>
<script>
  var globalShareHelper = null;

/*
  <li class="nav-item poem-item">
    <a class="nav-link"
      role="toggle" data-toggle="tab"
      href="#poem_towards_light">
      <div class="header">Towards Lights <br/>(Happy Diwali)</div>
      <img src="images/TowardsLight_Nov2020.jpg"
        width=200 height=200
        alt="Towards Light"/>
    </a>
  </li>
*/
  function fetchHelper( fetchFrom) {
    // console.log( "About to fetch from ", fetchFrom);
    return fetch( fetchFrom)
      .then( response => {
        if (response.ok) {
          return response;
        } else {
          let error = new Error( "Error in fetching Items. Status: "
            + response.status + "; status text: " + response.statustext);
          error.response = response;
          throw error;
        }
      },
      error => {
          let errmess = new Error( error.message);
          throw errmess;
      });
  }

  function fetchItem( item, index)
  {
    const itemFrom = getUrlForContent( item);
    console.log( `Fetching content from ${itemFrom}`);
    return fetchHelper( itemFrom)
      .then( response => response.text())
      .catch( error => {
        console.log( `ERROR in fetching content from ${itemFrom}`);
        console.log( error);
      });
  }


  function genListItem( item, index) {
    const hrefIdForItem = 'poem_' + item.url;

    return '<li class="nav-item poem-item">'
            + '<a class="nav-link"'
            + '  role="toggle" data-toggle="tab"'
            + '    href="#' + hrefIdForItem + '">'
            + '    <div class="header">' + item.title + '</div>'
            + '    <img src="images/' + item.image + '"'
            + '      width=200 height=200'
            + '      alt="' + item.title + '"/>'
            + '  </a>'
            + '</li>'
          ;
  }

  function genContentItem( item, index) {
    const fullItemContent = "Coming Soon ...";
    const classForItem = 'tab-pane fade ' + ((index === 0) ? 'show active' : '');
    const hrefIdForItem = 'poem_' + item.url;
    const idForPreContent = 'pre_' + item.url;
    const itemShareUrl = 'javascript:useShareHelper( \''
      + item.title
      + '\', null, \'https://zanavu.com/poems#' + hrefIdForItem + '\')';

    // console.log( `Rendering Item.Title: ${item.title}`);
    // console.log( `Rendering itemShareUrl: ${itemShareUrl}`);

    let itemx =
      '<div id="' + hrefIdForItem + '" role="tabpanel" class="' + classForItem + '">'
      + '<h4>' + item.title + '</h4>'
      + '<div class="poem_text" id="' + idForPreContent + '">'
      + fullItemContent
      + '</div>'
      + '<a class="nav-link" share-button '
      + '    href="' + itemShareUrl + '">'
      + ' <i class="fas fa-share"></i>Share</a>'
      + '</div>'
      ;

    // queue up fetching the content item and adding to display node
    fetchItem( item, index)
      .then( content => {
        let nodeForContent = $('#' + idForPreContent);
        // console.log( `content for item at ${idForPreContent} is `, nodeForContent.text());
        // console.log( `new content is \n ${content}`);
        nodeForContent.text( content);
      });

    // console.log( itemx);
    return itemx;
  }

  const itemsDirectoryUrl = "/poems/content/_items.json";
  function getUrlForContent( item) {
    return "/poems/content/" + item.url + ".txt";
  }


  function FetchSideBarItems() {
    // console.log( `Fetching sidebar items from ${itemsDirectoryUrl}`);
    return fetchHelper( itemsDirectoryUrl)
      .then( response => response.json())
      .catch( error => {
        console.log( `ERROR in fetching items from ${itemFrom}`);
        console.log( error);
      });
  }

  function AddDynamicContent( items) {
    let contentList = $('#main_content');
    let sidebarList = $('#sidebar_links');
    // console.log( "About to add main items"); console.log( items);
    // console.log( rootListToAdd);

    // iterate and add items
    items.forEach( (item, index) => {
      // generate list item
      const contentItem = genContentItem( item, index);
      const sidebarItem = genListItem( item, index);

      // console.log(`Main Content Item [${index}] is: ${contentItem}`);
      // console.log(`Sidebar Item [${index}] is: ${sidebarItem}`);

      // add the list item
      contentList.append( contentItem);
      // add the list item
      sidebarList.append( sidebarItem);
    });
  }

  function CheckAndEnableSharing() {
    if ( ShareHelper.canShare()) {
      // enable sharing mode ... or else disable it

      // console.log( "Setting up the useShareHelper ... ");
      globalShareHelper = new ShareHelper( '#output');
    } else {
      // disable share links

      // console.log( "Disable and remove the sharing buttons ... ");
      let nodes = $('[share-button]');
      // nodes.remove();  // removal ensures sharing is NOT shown
      nodes.css( 'display', 'none'); // does not show the item
      // console.log( nodes);
    }
  }

  $(document).ready( function() {

    FetchSideBarItems()
      .then( items => AddDynamicContent( items))
      ;
    CheckAndEnableSharing();
  });

  function useShareHelper( title, text, url) {
    if ( text === null) { text = title;}
    console.log( `Sharing ... ${title} with text: ${text} for URL: ${url}`);
    if ( globalShareHelper) { globalShareHelper.webShare(  title, text, url); }
    else { console.log("Sharing is NOT enabled");}
  }
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-68421266-1', 'auto');
     ga('send', 'pageview');
</script>
</body>
</html>
